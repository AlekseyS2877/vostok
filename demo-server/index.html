<!DOCTYPE html>
<html lang="en">
<head>
<title>Vostok translator</title>
<style type="text/css" media="screen">
  #editor {
    width: 600px;
    height: 600px;
    font-size: 14px;
    float: left;
  }
  #log {
    width: 600px;
    height: 600px;
    overflow: auto;
    float:right;
    background-color: #EEEEEE;
  }
  .log-script {
    background-color: #F9F9F9;
    padding: 4px;
    border-radius: 6px;
    margin: 0px;
  }
  .log-out {
    margin: 0px;
  }
</style>
</head>

<body>

<div style='width:1200px'>
  <div id='editor'>MODULE Hello;

 IMPORT Out;

 PROCEDURE Come*;
 BEGIN
   Out.String("Добро пожаловать."); Out.Ln
 END Come;

 PROCEDURE Gone*;
 BEGIN
   Out.String("До скорой встречи."); Out.Ln
 END Gone;

END Hello.
</div>

  <div id='log'></div>

</div>

<div id='runners'></div>

<div>
  <input type='text' id='script' value='Hello.Come; Hello.Gone'/>
  <button onclick='requestRun(script.value)'>Run</button>
  <button onclick='addRunner(script.value)'>Add</button>
</div>

<script src="https://ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js"
        type="text/javascript" charset="utf-8">
</script>

<script>
  var editor, session, script, runners, mlog;

  script  = document.getElementById('script');
  runners = document.getElementById('runners');
  mlog = document.getElementById('log');

  editor = ace.edit('editor');
  editor.setDisplayIndentGuides(true);
  session = editor.getSession();
  session.setOptions({ tabSize: 2, useSoftTabs: true, navigateWithinSoftTabs: true});

  function requestRun(scr) {
    var req, data, pre, div, table;

    pre = document.createElement('pre');
    pre.innerText = scr;
    pre.className = 'log-script';
    table = document.createElement('table');
    table.appendChild(pre);
    mlog.appendChild(table);

    req = new XMLHttpRequest();
    req.onreadystatechange = function() {
      if ((XMLHttpRequest.DONE == req.readyState) && (200 == req.status)) {
        pre = document.createElement('pre');
        pre.innerText = req.responseText;
        pre.className = 'log-out';
        mlog.appendChild(pre);
        pre.scrollIntoView();
      }
      if (400 <= req.status) {
        div = document.createElement('div');
        if (500 > req.status) {
          div.innerText = 'Client error code : ' + req.status;
        } else {
          div.innerText = 'Server error code : ' + req.status;
        }
        mlog.appendChild(div);
      }
    }
    req.ontimeout = function (e) {
      console.log('ontimeout ' + e);
    };
    req.open('POST', '/run');
    data = new FormData();
    data.append('module', session.getValue());
    data.append('script', scr);
    req.send(data);
  }

  function addRunner(command) {
    var div, inp, run, del;
    div = document.createElement('div');
    inp = document.createElement('input', 'type="text"');
    inp.value = command;
    run = document.createElement('button');
    run.innerText = 'Run';
    run.onclick = function() {
      requestRun(inp.value);
    }
    del = document.createElement('button');
    del.innerText = 'Del';
    del.onclick = function() {
      runners.removeChild(div);
    }

    div.appendChild(inp);
    div.appendChild(run);
    div.appendChild(del);

    runners.appendChild(div);
  }

  addRunner('Hello.Come');
  addRunner('Hello.Gone');
</script>

</body>
</html>
